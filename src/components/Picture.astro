---
import fs from "node:fs";

const {
  src,
  alt = "",
  width,
  height,
  sizes = "(min-width: 900px) 960px, 100vw",
  loading = "lazy",
  decoding = "async",
} = Astro.props;

const isPath = typeof src === "string" && src.startsWith("/");
const rootRelative = isPath ? src.slice(1) : undefined;
const candidateWebp = typeof src === "string" ? src.replace(/\.(jpe?g|png)$/i, ".webp") : src;
const webpPath = isPath && typeof candidateWebp === "string"
  ? new URL(`../../public/${candidateWebp.replace(/^\//, "")}`, import.meta.url)
  : null;
const hasWebp = webpPath ? fs.existsSync(webpPath) : false;
const imagePath = isPath && rootRelative ? new URL(`../../public/${rootRelative}`, import.meta.url) : null;
const imageSrc = typeof src === "string" ? src : undefined;
const sourceSrc = hasWebp ? candidateWebp : undefined;
const hasImage = imagePath ? fs.existsSync(imagePath) : true;
---
<picture>
  {sourceSrc && <source srcset={sourceSrc} type="image/webp" />}
  <img
    src={hasImage ? imageSrc : src}
    alt={alt}
    width={width}
    height={height}
    sizes={sizes}
    loading={loading}
    decoding={decoding}
  />
</picture>
