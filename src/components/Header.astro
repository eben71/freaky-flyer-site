---
const navItems = [
  { href: '/', label: 'Home' },
  {
    href: '/about',
    label: 'About Us',
    children: [
      { href: '/about/our-story', label: 'Our Story' },
      { href: '/about/meet-the-team', label: 'Meet The Team' },
    ],
  },
  {
    href: '/flyer-delivery',
    label: 'Flyer Delivery',
    children: [
      { href: '/flyer-delivery/our-technique', label: 'Our Technique' },
      { href: '/flyer-delivery/pricing', label: 'Pricing' },
      { href: '/flyer-delivery/schedule', label: 'Schedule' },
    ],
  },
  { href: '/flyer-tips', label: 'Flyer Tips' },
  { href: '/gps-tracking', label: 'GPS Tracking' },
  { href: '/contact', label: 'Contact Us' },
];

const normalizePath = (path) => {
  if (!path) return '/';
  const cleaned = path.replace(/\/+$/, '');
  return cleaned.length > 0 ? cleaned : '/';
};

const currentPath = normalizePath(Astro.url.pathname);

const isActive = (item) => {
  const directMatch = normalizePath(item.href) === currentPath;
  if (directMatch) {
    return true;
  }

  if (Array.isArray(item.children)) {
    return item.children.some((child) => normalizePath(child.href) === currentPath);
  }

  return false;
};
---
<header class="site" role="banner">
  <div class="topbar">
    <div class="container topbar__content">
      <div class="topbar__info">
        <span>Contact the Perth Flyer Distribution Specialists</span>
        <span class="divider" aria-hidden="true">|</span>
        <a href="tel:+61894057777">P: (08) 9405 7777</a>
        <span class="divider" aria-hidden="true">|</span>
        <a href="mailto:admin@freakyflyerdelivery.com.au">E: admin@freakyflyerdelivery.com.au</a>
      </div>
      <div class="topbar__social" role="list" aria-label="Follow Freaky Flyer Delivery">
        <a
          class="social-link"
          role="listitem"
          href="https://x.com/flyerfreaky"
          target="_blank"
          rel="noopener noreferrer"
        >
          <span class="sr-only">X (formerly Twitter)</span>
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path
              d="M3 3h4.9l4 5.4L16.2 3H21l-7.2 8.7L21 21h-4.9l-4.3-5.8L7.8 21H3l7.5-9.3L3 3z"
            />
          </svg>
        </a>
        <a
          class="social-link"
          role="listitem"
          href="https://www.facebook.com/FreakyFlyerDelivery"
          target="_blank"
          rel="noopener noreferrer"
        >
          <span class="sr-only">Facebook</span>
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path
              d="M13.6 21v-7h2.4l.4-2.8h-2.8v-1.8c0-.8.2-1.4 1.5-1.4H16V5.6c-.3 0-1.1-.1-2-.1-2 0-3.3 1.2-3.3 3.4v2H8.6V14h2.1v7h2.9z"
            />
          </svg>
        </a>
        <a
          class="social-link"
          role="listitem"
          href="https://www.instagram.com/freakyflyerdelivery"
          target="_blank"
          rel="noopener noreferrer"
        >
          <span class="sr-only">Instagram</span>
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path
              d="M8 3.5h8c2.5 0 4.5 2 4.5 4.5v8c0 2.5-2 4.5-4.5 4.5H8c-2.5 0-4.5-2-4.5-4.5v-8C3.5 5.5 5.5 3.5 8 3.5zm0 1.5C6.1 5 4.5 6.6 4.5 8.5v7c0 1.9 1.6 3.5 3.5 3.5h7c1.9 0 3.5-1.6 3.5-3.5v-7C18.5 6.6 16.9 5 15 5H8zm8.4 1.8a1 1 0 1 1 0 2.1 1 1 0 0 1 0-2.1zM12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8zm0 1.8A2.2 2.2 0 1 0 12 16a2.2 2.2 0 0 0 0-4.4z"
            />
          </svg>
        </a>
      </div>
    </div>
  </div>
  <div class="container">
    <nav class="nav" aria-label="Primary navigation">
      <a class="brand" href="/" aria-label="Freaky Flyer Delivery">
        <img src="/assets/brand/ffd-logo.svg" alt="Freaky Flyer Delivery" width="140" height="36" />
      </a>
      <ul class="nav-links">
        {navItems.map((item) => {
          const isParent = Array.isArray(item.children) && item.children.length > 0;
          const itemClass = [isParent ? 'has-submenu' : null, isActive(item) ? 'is-active' : null]
            .filter(Boolean)
            .join(' ');
          return (
            <li class={itemClass || undefined}>
              <a
                class={isActive(item) ? 'is-active' : undefined}
                href={item.href}
                aria-haspopup={isParent ? 'true' : undefined}
              >
                {item.label}
              </a>
              {isParent && (
                <ul class="nav-submenu" aria-label={`${item.label} submenu`}>
                  {item.children.map((child) => (
                    <li>
                      <a
                        class={normalizePath(child.href) === currentPath ? 'is-active' : undefined}
                        href={child.href}
                      >
                        {child.label}
                      </a>
                    </li>
                  ))}
                </ul>
              )}
            </li>
          );
        })}
      </ul>
    </nav>
  </div>
</header>
